name: Deploy dev and feature branches

on:
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  workflow_dispatch:       # Allow triggering manually

jobs:
  find-prs-to-deploy:
    name: Find PRs and branches to deploy or uninstall
    runs-on: ubuntu-latest
    outputs:
      to-uninstall: ${{ steps.to-uninstall.outputs.list }}
      to-deploy: ${{ steps.to-deploy.outputs.list }}
      never-uninstall: ${{ steps.to-uninstall.outputs.never_uninstall }}
    steps:

      - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3

      - name: Get CI status of the devel branch
        id: devel-ci
        run: |
          DEVEL_GREEN=$(curl -X POST --location "https://api.github.com/graphql" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.REPO_ACCESS_TOKEN }}" \
              -d "{\"query\": \"query { repository(owner: \\\"ecamp\\\", name: \\\"ecamp3\\\") { ref(qualifiedName: \\\"devel\\\") { target { ... on Commit { statusCheckRollup { state } } } } } }\"}" \
            | jq '.data.repository.ref.target.statusCheckRollup.state=="SUCCESS"')
          echo "Devel CI has passed (within the last 100 CI workflow runs across all forks): $DEVEL_GREEN"
          echo "passed=$DEVEL_GREEN" | tr -d "\n" >> $GITHUB_OUTPUT

      - name: Find all open PRs that have a "deploy!" label, plus devel
        id: deployment-candidates
        # create a list of JSON objects like:
        # [
        #  {"name": "pr1234", "env": "feature-branch", "sha": "... commit sha ...", "number": "1234"},
        #  {"name": "dev", "env": "dev", "sha": "...", "number": ""}
        # ]
        run: |
          DEVEL=$(printf '{"name":"dev","env":"dev","sha":"%s","number":""}' $(git rev-parse devel))
          PULL_REQUESTS=$(curl -X POST --location "https://api.github.com/graphql" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.REPO_ACCESS_TOKEN }}" \
            -d "{\"query\": \"query { search(query: \\\"is:open is:pr label:deploy! repo:ecamp/ecamp3\\\", type: ISSUE, first: 100) { edges { node { ... on PullRequest { number headRefOid } } } } }\"}")
          LIST=$(printf "$PULL_REQUESTS" | jq '.data.search.edges' \
            | jq 'map({"name":("pr"+(.node.number|tostring)),env:"feature-branch",sha:.node.headRefOid,number:(.node.number|tostring)})' \
            | jq ".+[$DEVEL]")
          echo "Deployment candidates: $LIST"
          echo "list=$LIST" | tr -d "\n" >> $GITHUB_OUTPUT

      - name: Read the list of all currently active deployments
        id: current-deployments
        run: |
          # Setup authentication
          mkdir ~/.kube && echo '${{ secrets.KUBECONFIG }}' > ~/.kube/config && chmod go-r ~/.kube/config
          # Read list of deployments using helm, and remove the leading ecamp3- from each of the names.
          # Creates a list of objects like [{"name": "pr1234", "sha": "... commit sha ..."}, {"name": "dev", "sha": "..."}]
          LIST=$(helm list -o json | jq 'map(.name|=sub("^ecamp3-";""))' | jq 'map({name:.name,sha:.app_version})')
          echo "Currently active deployments: $LIST"
          echo "list=$LIST" | tr -d "\n" >> $GITHUB_OUTPUT

      - name: List deployments without PR
        id: to-uninstall
        env:
          deployments: ${{ toJSON(fromJSON(steps.current-deployments.outputs.list).*.name) }}
          prs: ${{ toJSON(fromJSON(steps.deployment-candidates.outputs.list).*.name) }}
          never_uninstall: '["dev", "devel", "stage", "staging", "prod"]'
        run: |
          TO_UNINSTALL=$(jq --null-input --argjson prs '${{ env.prs }}' --argjson deployments '${{ env.deployments }}' --argjson never_uninstall '${{ env.never_uninstall }}' '$deployments-$prs-$never_uninstall')
          echo "Will uninstall: $TO_UNINSTALL"
          echo "list=$TO_UNINSTALL" | tr -d "\n" >> $GITHUB_OUTPUT
          echo "\n" >> $GITHUB_OUTPUT
          echo "never_uninstall=$never_uninstall" | tr -d "\n" >> $GITHUB_OUTPUT

      - name: List PRs without up-to-date deployment
        id: to-deploy
        env:
          deployments: ${{ steps.current-deployments.outputs.list }}
          prs: ${{ steps.deployment-candidates.outputs.list }}
          allow_dev: ${{ steps.devel-ci.outputs.passed }}
        run: |
          TO_INSTALL=$(jq --null-input --argjson prs '${{ env.prs }}' --argjson deployments '${{ env.deployments }}' \
            '$prs|map(select([{name:.name,sha:.sha}]|inside($deployments)|not))' \
            | jq --argjson allow_dev "${{ env.allow_dev }}" 'map(select((.name!="dev")or($allow_dev==true)))')
          echo "Will install the following candidates, because they either aren't deployed or their deployment is out of date: $TO_INSTALL"
          echo "list=$TO_INSTALL" | tr -d "\n" >> $GITHUB_OUTPUT

  uninstall-old-deployment:
    name: Uninstall old deployment
    runs-on: ubuntu-latest
    needs:
      - find-prs-to-deploy
    if: fromJSON(needs.find-prs-to-deploy.outputs.to-uninstall)[0] != null
    strategy:
      fail-fast: false
      matrix:
        deployment-name: ${{ fromJSON(needs.find-prs-to-deploy.outputs.to-uninstall) }}
    steps:

      - name: Uninstall helm release
        run: |
          # Setup authentication
          mkdir ~/.kube && echo '${{ secrets.KUBECONFIG }}' > ~/.kube/config && chmod go-r ~/.kube/config
          # Uninstall the release
          helm delete ecamp3-${{ matrix.deployment-name }}

      - name: Remove GitHub deployment
        uses: bobheadxi/deployments@v1.4.0
        with:
          step: deactivate-env
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          env: ${{ matrix.deployment-name }}

      - name: Find former PR number based on deployment name
        id: pr-number
        env:
          name: ${{ matrix.deployment-name }}
          regex: '^pr([0-9]+)$'
        run: |
          [[ $name =~ $regex ]]
          echo number=${BASH_REMATCH[1]} >> $GITHUB_OUTPUT

      - name: Comment about uninstallation on PR
        uses: thollander/actions-comment-pull-request@v2
        if: steps.pr-number.outputs.number
        with:
          pr_number: ${{ steps.pr-number.outputs.number }}
          message: |
            ### <span aria-hidden="true">‚õî</span> Feature branch deployment currently inactive.


            If the PR is still open, you can add the `deploy!` label to this PR to trigger a feature branch deployment.
          comment_tag: feature-branch-deployment-status
          create_if_not_exists: false

  build-and-push:
    name: Build and push docker images  
    needs: find-prs-to-deploy
    uses: ./.github/workflows/reusable-build-and-push.yml
    strategy:
      fail-fast: false
      matrix:
        deployment: ${{ fromJSON(needs.find-prs-to-deploy.outputs.to-deploy) }}
    with:
      tag: ${{ ((matrix.deployment.name == 'dev') && 'latest' || '') }}
      sha: ${{ matrix.deployment.sha }}
    secrets:
      DOCKER_HUB_USERNAME: ${{ vars.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

  upgrade-or-install-deployment:
    name: Upgrade or install deployment
    runs-on: ubuntu-latest
    needs:
      - find-prs-to-deploy
      - build-and-push
    if: fromJSON(needs.find-prs-to-deploy.outputs.to-deploy)[0] != null
    strategy:
      fail-fast: false
      matrix:
        deployment: ${{ fromJSON(needs.find-prs-to-deploy.outputs.to-deploy) }}
    environment:
      name: ${{ matrix.deployment.env }}
    steps:

      - name: Get link to currently running job logs
        uses: Tiryoh/gha-jobid-action@v0.1.2
        id: job-url
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: Upgrade or install deployment (${{ matrix.deployment.name }}, ${{ matrix.deployment.env }}, ${{ matrix.deployment.sha }}, ...

      - name: Create a pending GitHub deployment
        uses: bobheadxi/deployments@v1.4.0
        id: deployment
        with:
          step: start
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          env: ${{ matrix.deployment.name }}

      - name: Comment progress on PR
        uses: thollander/actions-comment-pull-request@v2
        if: ${{ matrix.deployment.env == 'feature-branch' }}
        with:
          pr_number: ${{ matrix.deployment.number }}
          message: |
            ### <span aria-hidden="true">üèóÔ∏è</span> Feature branch deployment in progress


            |  Name | Link |
            |---------------------------------|------------------------|
            |<span aria-hidden="true">üî®</span> Latest commit | [${{ matrix.deployment.sha }}](https://github.com/${{ github.repository }}/commit/${{ matrix.deployment.sha }}) |
            |<span aria-hidden="true">üîç</span> Latest deploy log | [${{ steps.job-url.outputs.html_url }}](${{ steps.job-url.outputs.html_url }}) |
          comment_tag: feature-branch-deployment-status
      
      - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3
        with:
          ref: ${{ matrix.deployment.sha }}

      - name: Upgrade or install helm release
        env:
          never_uninstall: ${{ needs.find-prs-to-deploy.outputs.never-uninstall }}
        run: |
          # Setup authentication
          mkdir ~/.kube && echo '${{ secrets.KUBECONFIG }}' > ~/.kube/config && chmod go-r ~/.kube/config
          # Switch to the helm chart directory
          cd .helm/ecamp3
          # Install dependency charts
          helm dependency update
          # Set the appVersion, workaround from https://github.com/helm/helm/issues/8194 so that we can
          # later find out which deployments need to be upgraded
          sed -i 's/^appVersion:.*$/appVersion: "${{ matrix.deployment.sha }}"/' Chart.yaml
          # Install or upgrade the release
          helm upgrade --install ecamp3-${{ matrix.deployment.name }} . \
            --set imageTag=${{ matrix.deployment.sha }} \
            --set termsOfServiceLinkTemplate='https://ecamp3.ch/{lang}/tos' \
            --set domain=${{ matrix.deployment.name }}.ecamp3.ch \
            --set mail.dummyEnabled=true \
            --set postgresql.url='${{ secrets.POSTGRES_URL }}/ecamp3${{ matrix.deployment.name }}?sslmode=require' \
            --set postgresql.adminUrl='${{ secrets.POSTGRES_ADMIN_URL }}/ecamp3${{ matrix.deployment.name }}?sslmode=require' \
            --set postgresql.dropDBOnUninstall=${{ contains(fromJson(env.never_uninstall), matrix.deployment.name) && 'false' || 'true' }} \
            --set php.dataMigrationsDir='${{ secrets.DATA_MIGRATIONS_DIR }}' \
            --set php.appSecret='${{ secrets.API_APP_SECRET }}' \
            --set php.sentryDsn='${{ secrets.API_SENTRY_DSN }}' \
            --set php.jwt.passphrase='${{ secrets.JWT_PASSPHRASE }}' \
            --set php.jwt.publicKey='${{ secrets.JWT_PUBLIC_KEY }}' \
            --set php.jwt.privateKey='${{ secrets.JWT_PRIVATE_KEY }}' \
            --set frontend.sentryDsn='${{ secrets.FRONTEND_SENTRY_DSN }}' \
            --set print.sentryDsn='${{ secrets.PRINT_SENTRY_DSN }}' \
            --set print.browserWsEndpoint='${{ secrets.BROWSER_WS_ENDPOINT }}' \
            --set deploymentTime="$(date -u +%s)" \
            --set deployedVersion="$(git rev-parse --short '${{ matrix.deployment.sha }}')" \
            --set recaptcha.siteKey='${{ secrets.RECAPTCHA_SITE_KEY }}' \
            --set recaptcha.secret='${{ secrets.RECAPTCHA_SECRET }}' \
            --set featureToggle.developer=true \
            --set coupon.secret='${{ secrets.COUPON_SECRET }}'

      - name: Finish the GitHub deployment
        uses: bobheadxi/deployments@v1.4.0
        if: always()
        with:
          step: finish
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          status: ${{ job.status }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://${{ matrix.deployment.name }}.ecamp3.ch
          env: ${{ steps.deployment.outputs.env }}

      - name: Get current time
        uses: josStorer/get-current-time@v2
        if: always()
        id: current-time
        with:
          timezone: Europe/Zurich

      - name: Comment success on PR
        uses: thollander/actions-comment-pull-request@v2
        if: ${{ success() && matrix.deployment.env == 'feature-branch' }}
        with:
          pr_number: ${{ matrix.deployment.number }}
          message: |
            ### <span aria-hidden="true">‚úÖ</span> Feature branch deployment ready!


            |  Name | Link |
            |---------------------------------|------------------------|
            |<span aria-hidden="true">üòé</span> **Deployment** | [https://${{ matrix.deployment.name }}.ecamp3.ch/](https://${{ matrix.deployment.name }}.ecamp3.ch/) |
            |<span aria-hidden="true">üîë</span> Login | `test@example.com` / `test` |
            |<span aria-hidden="true">üïí</span> Last deployed at | ${{ steps.current-time.outputs.readableTime }} |
            |<span aria-hidden="true">üî®</span> Latest commit | [${{ matrix.deployment.sha }}](https://github.com/${{ github.repository }}/commit/${{ matrix.deployment.sha }}) |
            |<span aria-hidden="true">üîç</span> Latest deploy log | [${{ steps.job-url.outputs.html_url }}](${{ steps.job-url.outputs.html_url }}) |
            |<span aria-hidden="true">üì±</span> Preview on mobile | <details><summary> Toggle QR Code... </summary><br /><br />![QR Code](https://api.qrserver.com/v1/create-qr-code/?size=180x180&ecc=H&format=svg&qzone=4&color=5-72-97&data=https://${{ matrix.deployment.name }}.ecamp3.ch/)<br /><br />_Use your smartphone camera to open QR code link._</details> |
            ---
          comment_tag: feature-branch-deployment-status

      - name: Comment failure on PR
        uses: thollander/actions-comment-pull-request@v2
        if: ${{ failure() && matrix.deployment.env == 'feature-branch' }}
        with:
          pr_number: ${{ matrix.deployment.number }}
          message: |
            ### <span aria-hidden="true">üí•</span> Feature branch deployment failed


            |  Name | Link |
            |---------------------------------|------------------------|
            |<span aria-hidden="true">üïí</span> Last attempted at | ${{ steps.current-time.outputs.readableTime }} |
            |<span aria-hidden="true">üî®</span> Latest commit | [${{ matrix.deployment.sha }}](https://github.com/${{ github.repository }}/commit/${{ matrix.deployment.sha }}) |
            |<span aria-hidden="true">üîç</span> Latest deploy log | [${{ steps.job-url.outputs.html_url }}](${{ steps.job-url.outputs.html_url }}) |
            ---
          comment_tag: feature-branch-deployment-status
