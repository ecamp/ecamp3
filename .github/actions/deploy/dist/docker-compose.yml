version: "3.4"

services:
  nginx:
    image: nginx@sha256:168a6a2be5c65d4aafa7a78ca98ff8b110fe44c6ca41e7ccb4314ed481e32288
    ports:
      - '80:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - print-output:/static-files
    depends_on:
      - caddy
      - frontend
      - print
#      - worker-print-puppeteer
#      - worker-print-weasy
      - mail

  frontend:
    image: ecamp/ecamp3-frontend:${DOCKER_IMAGE_TAG}
    volumes:
      - ./frontend-environment.js:/app/environment.js

  php:
    image: ecamp/ecamp3-api:${DOCKER_IMAGE_TAG}
    volumes:
      - caddy-socket:/var/run/php
      - api-keys:/srv/api/config/jwt
    environment:
      APP_ENV: dev
    healthcheck:
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    env_file:
      - api.env

  caddy:
    image: ecamp/ecamp3-caddy:${DOCKER_IMAGE_TAG}
    depends_on:
      - php
    environment:
      SERVER_NAME: localhost:4001, caddy:4001, ${API_DOMAIN}:4001
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_PUBLISHER_JWT_KEY:-!ChangeMe!}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_SUBSCRIBER_JWT_KEY:-!ChangeMe!}
      MERCURE_EXTRA_DIRECTIVES: demo
    volumes:
      - caddy-socket:/var/run/php
      - caddy-data:/data
      - caddy-config-cache:/config

  print:
    image: ecamp/ecamp3-print:${DOCKER_IMAGE_TAG}
    env_file:
      - print.env

#  print:
#    image: ecamp/ecamp3-print:${DOCKER_IMAGE_TAG}
#    container_name: 'ecamp3-print'
#    env_file:
#      - print.env
#
#  rabbitmq:
#    image: rabbitmq:3.9-management@sha256:e65c880a794cf01f5e83cb80ebca282413e10a73f060fc81122866e42ed4afc0
#    container_name: 'ecamp3-rabbitmq'
#    env_file:
#      - rabbitmq.env
#
#  worker-print-puppeteer:
#    image: ecamp/ecamp3-worker-print-puppeteer:${DOCKER_IMAGE_TAG}
#    container_name: 'ecamp3-worker-print-puppeteer'
#    volumes:
#      - ./worker-print-puppeteer-environment.js:/app/environment.js
#      - print-output:/app/data
#    depends_on:
#      - rabbitmq
#
#  worker-print-weasy:
#    image: ecamp/ecamp3-worker-print-weasy:${DOCKER_IMAGE_TAG}
#    container_name: 'ecamp3-worker-print-weasy'
#    volumes:
#      - ./worker-print-weasy-environment.py:/app/environment.py
#      - print-output:/app/data
#    depends_on:
#      - rabbitmq

  mail:
    image: mailhog/mailhog@sha256:8d76a3d4ffa32a3661311944007a415332c4bb855657f4f6c57996405c009bea

volumes:
  api-keys:
  caddy-socket:
  caddy-data:
  caddy-config-cache:
  print-output:
