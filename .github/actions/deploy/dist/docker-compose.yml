version: "3.4"

services:
  nginx:
    image: nginx@sha256:765e51caa9e739220d59c7f7a75508e77361b441dccf128483b7f5cce8306652
    container_name: 'ecamp3-nginx'
    ports:
      - '80:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - print-output:/static-files
    depends_on:
      - backend
      - frontend
      - print
      - worker-print-puppeteer
#      - worker-print-weasy
      - mail

  frontend:
    image: ecamp/ecamp3-frontend:${DOCKER_IMAGE_TAG}
    container_name: 'ecamp3-frontend'
    volumes:
      - ./frontend-environment.js:/app/environment.js

  backend:
    image: ecamp/ecamp3-backend:${DOCKER_IMAGE_TAG}
    container_name: 'ecamp3-backend'
    volumes:
      - ./doctrine.local.prod.php:/app/config/autoload/doctrine.local.prod.php
      - ./mail.local.prod.php:/app/config/autoload/mail.local.prod.php
      - ./sessions.local.prod.php:/app/config/autoload/sessions.local.prod.php
      - ./zfr_cors.global.php:/app/config/autoload/zfr_cors.global.php
      - ./sentry.config.php:/app/config/sentry.config.php
    depends_on:
      - rabbitmq

  php:
    image: ecamp/ecamp3-api:${DOCKER_IMAGE_TAG}
    volumes:
      - caddy-socket:/var/run/php
      - api-keys:/srv/api/config/jwt
    environment:
      APP_ENV: dev
    healthcheck:
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    user: 1000
    env_file:
      - api.env

  caddy:
    depends_on:
      - php
    environment:
      SERVER_NAME: ${SERVER_NAME:-localhost:4001, localhost:4443, caddy:4001}
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_PUBLISHER_JWT_KEY:-!ChangeMe!}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_SUBSCRIBER_JWT_KEY:-!ChangeMe!}
      MERCURE_EXTRA_DIRECTIVES: demo
    ports:
      # HTTP
      - target: 4001
        published: 4001
        protocol: tcp
      # HTTPS
      - target: 4443
        published: 4443
        protocol: tcp
      # HTTP/3
      - target: 4443
        published: 4443
        protocol: udp
    restart: unless-stopped
    user: ${USER_ID:-1000}
    volumes:
      - caddy-socket:/var/run/php
      - caddy-data:/data
      - caddy-config-cache:/config

  print:
    image: ecamp/ecamp3-print:${DOCKER_IMAGE_TAG}
    container_name: 'ecamp3-print'
    env_file:
      - print.env

  rabbitmq:
    image: rabbitmq:3.9-management@sha256:e65c880a794cf01f5e83cb80ebca282413e10a73f060fc81122866e42ed4afc0
    container_name: 'ecamp3-rabbitmq'
    env_file:
      - rabbitmq.env

  worker-print-puppeteer:
    image: ecamp/ecamp3-worker-print-puppeteer:${DOCKER_IMAGE_TAG}
    container_name: 'ecamp3-worker-print-puppeteer'
    volumes:
      - ./worker-print-puppeteer-environment.js:/app/environment.js
      - print-output:/app/data
    depends_on:
      - rabbitmq

#  worker-print-weasy:
#    image: ecamp/ecamp3-worker-print-weasy:${DOCKER_IMAGE_TAG}
#    container_name: 'ecamp3-worker-print-weasy'
#    volumes:
#      - ./worker-print-weasy-environment.py:/app/environment.py
#      - print-output:/app/data
#    depends_on:
#      - rabbitmq

  mail:
    image: mailhog/mailhog@sha256:8d76a3d4ffa32a3661311944007a415332c4bb855657f4f6c57996405c009bea
    container_name: 'ecamp3-mail'

volumes:
  api-keys:
  caddy-socket:
  caddy-data:
  caddy-config-cache:
  print-output:
