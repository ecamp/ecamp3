version: "3"

services:
  frontend:
    image: node:14.17.0@sha256:9025a77b2f37fcda3bbd367587367a9f2251d16a756ed544550b8a571e16a653
    container_name: 'ecamp3-frontend'
    ports:
      - '3000:3000'
      - '9229:9229' # jest debug 
    stdin_open: true
    tty: true
    user: ${USER_ID:-1000}
    volumes:
      - ./frontend:/app:delegated
      - ./common:/common:delegated
      - ./.cache/npm:/home/node/.npm
      - ./.cache/cypress:/home/node/.cache/Cypress
      - ./.cache/node_modules:/app/node_modules/.cache
    working_dir: /app
    command: ./docker-setup.sh
    environment:
      - NODE_ENV=development
      - NPM_CONFIG_UPDATE_NOTIFIER=false
      - NPM_CONFIG_CACHE=/home/node/.npm
      - CYPRESS_CACHE_FOLDER=/home/node/.cache/Cypress

  backend:
    build: ./backend
    container_name: 'ecamp3-backend'
    depends_on:
      - db
      - docker-host
    ports:
      - '3001:3001'
    user: ${USER_ID:-1000}
    volumes:
      - ./backend:/app:delegated
    entrypoint: ./docker-setup.sh

  print:
    image: node:14.17.0@sha256:9025a77b2f37fcda3bbd367587367a9f2251d16a756ed544550b8a571e16a653
    container_name: 'ecamp3-print'
    ports:
      - '3003:3003'
    user: ${USER_ID:-1000}
    volumes:
      - ./print:/app:delegated
      - ./common:/common:delegated
      - ./.cache/npm:/home/node/.npm
      - ./.cache/node_modules:/app/node_modules/.cache
    working_dir: /app
    command: ./docker-setup.sh
    environment:
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3003
      - NPM_CONFIG_UPDATE_NOTIFIER=false
      - NPM_CONFIG_CACHE=/home/node/.npm
    env_file:
      - ./print/print.env

  composer:
    image: composer:2@sha256:f5b199884a4f5ea0554f482d8efc490d5b4ca17597f90ba13f7bf7ae62c08cd5
    container_name: 'ecamp3-composer'
    restart: 'no'
    command: bash -c "composer install --no-interaction --no-plugins --no-scripts --prefer-dist"
    user: ${USER_ID:-1000}
    volumes:
      - ./backend:/app:delegated
      - ./.cache/composer:/tmp/cache

  db:
    image: mysql:8.0.25@sha256:d50098d7fcb25b1fcb24e2d3247cae3fc55815d64fec640dc395840f8fa80969
    container_name: 'ecamp3-db'
    environment:
      - MYSQL_DATABASE=ecamp3dev
      - MYSQL_ROOT_PASSWORD=will-be-randomized-and-output-on-the-console
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_USER=ecamp3
      - MYSQL_PASSWORD=ecamp3
    ports:
      - '3006:3306'
    volumes:
      - db-data:/var/lib/mysql

  phpmyadmin:
    image: phpmyadmin/phpmyadmin@sha256:8911fb0cfef21dc9fb385ad02cc3254179cd7df87bab3d3a6fa04d1f0549463f
    container_name: 'ecamp3-phpmyadmin'
    ports:
      - '3002:80'
    volumes:
      - ./phpmyadmin/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php

  rabbitmq:
    image: rabbitmq:3.8-management@sha256:ea9d5b4a6fdf8e39c56016623d2bfc6e4e79682e1bc1f71b318dc153c64dfb18
    container_name: 'ecamp3-rabbitmq'
    ports:
      - '3004:15672'

  worker-print-puppeteer:
    build: ./workers/print-puppeteer
    container_name: 'ecamp3-worker-print-puppeteer'
    user: ${USER_ID:-1000}
    volumes:
      - ./workers/print-puppeteer:/app:delegated
      - ./.cache/npm:/home/node/.npm
      - ./.print-data:/app/data
    command: ./docker-setup.sh
    environment:
      - NPM_CONFIG_UPDATE_NOTIFIER=false
      - NPM_CONFIG_CACHE=/home/node/.npm

  worker-print-weasy:
    build: ./workers/print-weasy
    container_name: 'ecamp3-worker-print-weasy'
    user: ${USER_ID:-1000}
    volumes:
      - ./workers/print-weasy:/app:delegated
      - ./.print-data:/app/data

  print-file-server:
    image: halverneus/static-file-server@sha256:833cd54b12085d7321e81ebed207fe3cfdbe8414d0d060c148987a4df0eeb3e3
    container_name: 'ecamp3-print-file-server'
    volumes:
      - ./.print-data:/web
    ports:
      - '3005:8080'
    environment:
      - CORS=true

  mail:
    image: mailhog/mailhog@sha256:8d76a3d4ffa32a3661311944007a415332c4bb855657f4f6c57996405c009bea
    container_name: 'ecamp3-mail'
    ports:
      - '8025:8025' # web UI

  docker-host:
    image: qoomon/docker-host@sha256:e4c68999056cc870bb7003d5d97ba8badfeea933435d2af239d3a3a6c38163ff
    container_name: 'ecamp3-docker-host-forwarder'
    cap_add: [ 'NET_ADMIN', 'NET_RAW' ]
    restart: on-failure

volumes:
  db-data:
