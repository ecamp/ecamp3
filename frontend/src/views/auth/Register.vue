<template>
  <auth-container>
    <h1 class="display-1 text-center">{{ $tc('views.auth.register.title') }}</h1>
    <validation-observer v-slot="{ handleSubmit }">
      <v-form @submit.prevent="handleSubmit(register)">
        <e-text-field
          v-model="firstname"
          :name="$tc('entity.user.fields.firstname')"
          vee-rules="required"
          append-icon="mdi-account-outline"
          dense
          type="text"
        />

        <e-text-field
          v-model="surname"
          :name="$tc('entity.user.fields.surname')"
          vee-rules="required"
          append-icon="mdi-account-outline"
          dense
          type="text"
        />

        <e-text-field
          v-model="email"
          :name="$tc('entity.user.fields.email')"
          vee-rules="email|required"
          append-icon="mdi-at"
          dense
          type="text"
        />

        <e-text-field
          v-model="pw1"
          :name="$tc('entity.user.fields.password')"
          vee-id="password"
          vee-rules="required|min:12|max:128"
          validate-on-blur
          append-icon="mdi-lock-outline"
          dense
          type="password"
          loading
          @input="debouncedPasswordStrengthCheck"
        >
          <template #progress>
            <v-progress-linear
              :value="passwordStrength"
              :color="passwordStrengthColor"
              absolute
              height="5"
            />
          </template>
        </e-text-field>

        <e-text-field
          v-model="pw2"
          :name="$tc('views.auth.register.passwordConfirmation')"
          vee-rules="required|confirmed:password"
          validate-on-blur
          dense
          append-icon="mdi-lock-outline"
          type="password"
        />

        <e-select
          v-model="language"
          :name="$tc('entity.user.fields.language')"
          dense
          :items="availableLocales"
        />

        <e-checkbox
          v-model="tos"
          :vee-rules="{ required: { allowFalse: false } }"
          class="align-center"
          :name="$tc('views.auth.register.acceptTermsOfUse')"
        >
          <template #label>
            <span style="hyphens: auto" :class="{ 'body-2': $vuetify.breakpoint.xsOnly }">
              {{ $tc('views.auth.register.acceptTermsOfUse') }}
            </span>
          </template>
          <template #append>
            <v-btn
              text
              dense
              min-width="0"
              :title="$tc('global.button.open')"
              target="_blank"
              class="px-1"
              to="#"
              tabindex="-1"
            >
              <v-icon small>mdi-open-in-new</v-icon>
            </v-btn>
          </template>
        </e-checkbox>

        <p class="mt-0 mb-4 text--secondary text-left">
          <small>
            <span style="color: #d32f2f">*</span>
            {{ $tc('views.auth.register.requiredField') }}
          </small>
        </p>

        <v-btn type="submit" color="primary" block x-large>
          <v-progress-circular v-if="registering" indeterminate size="24" />
          <v-spacer />
          <span>{{ $tc('views.auth.register.register') }}</span>
          <v-spacer />
          <icon-spacer />
        </v-btn>
      </v-form>
    </validation-observer>

    <p class="mt-8 mb-0 text--secondary text-center">
      {{ $tc('views.auth.register.alreadyHaveAnAccount') }}<br />
      <router-link :to="{ name: 'login' }">
        {{ $tc('global.button.login') }}
      </router-link>
    </p>
  </auth-container>
</template>

<script>
import { load } from 'recaptcha-v3'
import AuthContainer from '@/components/layout/AuthContainer.vue'
import { errorToMultiLineToast } from '@/components/toast/toasts'
import VueI18n from '@/plugins/i18n'
import { ValidationObserver } from 'vee-validate'
import { passwordStrengthMixin } from '../../mixins/passwordStrengthMixin.js'

export default {
  name: 'Register',
  components: {
    AuthContainer,
    ValidationObserver,
  },
  mixins: [passwordStrengthMixin],
  data() {
    return {
      registering: false,
      firstname: '',
      surname: '',
      email: '',
      pw1: '',
      pw2: '',
      language: '',
      tos: false,
      recaptcha: null,
    }
  },
  computed: {
    formData() {
      return {
        firstname: this.firstname,
        surname: this.surname,
        email: this.email,
        password: this.pw1,
        language: this.language,
      }
    },
    availableLocales() {
      return VueI18n.availableLocales.map((l) => ({
        value: l,
        text: this.$tc('global.language', 1, l),
      }))
    },
  },
  watch: {
    language() {
      if (VueI18n.availableLocales.includes(this.language)) {
        this.$store.commit('setLanguage', this.language)
      }
    },
  },
  mounted() {
    this.language = this.$i18n.browserPreferredLocale

    if (window.environment.RECAPTCHA_SITE_KEY) {
      this.recaptcha = load(window.environment.RECAPTCHA_SITE_KEY, {
        explicitRenderParameters: {
          badge: 'bottomleft',
        },
      })
    }
  },
  methods: {
    async register() {
      this.registering = true
      let recaptchaToken = null
      if (this.recaptcha) {
        const recaptcha = await this.recaptcha
        recaptchaToken = await recaptcha.execute('login')
      }

      this.$auth
        .register({
          password: this.formData.password,
          profile: {
            firstname: this.formData.firstname,
            surname: this.formData.surname,
            email: this.formData.email,
            language: this.formData.language,
          },
          recaptchaToken: recaptchaToken,
        })
        .then(() => this.$router.push({ name: 'register-done' }))
        .catch((e) => {
          this.$toast.error(errorToMultiLineToast(e))
          this.registering = false
        })
    },
  },
}
</script>
